(window.webpackJsonp=window.webpackJsonp||[]).push([[59],{514:function(a,s,t){"use strict";t.r(s);var e=t(8),n=Object(e.a)({},function(){var a=this,s=a.$createElement,t=a._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"linux-kernel-build"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#linux-kernel-build","aria-hidden":"true"}},[a._v("#")]),a._v(" Linux Kernel Build")]),a._v(" "),t("h2",{attrs:{id:"_1-预备工作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-预备工作","aria-hidden":"true"}},[a._v("#")]),a._v(" 1. 预备工作")]),a._v(" "),t("p",[a._v("阿里云开源镜像站下载内核："),t("a",{attrs:{href:"http://mirrors.aliyun.com/",target:"_blank",rel:"noopener noreferrer"}},[a._v("阿里云"),t("OutboundLink")],1),a._v("。下载内核和patch包。")]),a._v(" "),t("p",[a._v("安装必要的软件")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#安装必要的软件")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("apt-get")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" kernel-package build-essential libncurses5-dev fakeroot\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#解压缩内核")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("tar")]),a._v(" -xzf linux-4.x.x.tar.gz\n")])])]),t("p",[a._v("把内核目录linux-4.x.x和补丁patch都复制到/usr/src，然后进入/usr/src")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("cp")]),a._v(" linux-x.x /usr/src -rf\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("cp")]),a._v(" patch-x.x /user/src\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("cd")]),a._v(" /usr/src\n")])])]),t("h2",{attrs:{id:"_2-准备编译"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-准备编译","aria-hidden":"true"}},[a._v("#")]),a._v(" 2. 准备编译")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#复制当前内核的config文件到linux-x.x/下")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("cp")]),a._v(" linux-headers-"),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("uname")]),a._v(" -r"),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("/.config linux-x.x/\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("cd")]),a._v(" linux-x.x/\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("make")]),a._v(" menuconfig\n")])])]),t("p",[a._v("选择load→OK→Save→OK→EXIT→EXIT的执行顺序。")]),a._v(" "),t("h2",{attrs:{id:"_3-开始编译"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-开始编译","aria-hidden":"true"}},[a._v("#")]),a._v(" 3. 开始编译")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 编译启动映像，N表示CPU核数，单核为2.双核为4，以此类推")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("make")]),a._v(" bzImage -jN\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#编译模块")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("make")]),a._v(" modules -jN\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#安装模块")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("make")]),a._v(" modules-install\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("#安装内核")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("make")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v("\n")])])]),t("h2",{attrs:{id:"_4-更新grub"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-更新grub","aria-hidden":"true"}},[a._v("#")]),a._v(" 4. 更新grub")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 4.5.0为版本号")]),a._v("\nmkinitramfs 4.5.0 -o /boot/initrd.img-4.5.0\nupdate-grub2\n")])])]),t("hr"),a._v(" "),t("h2",{attrs:{id:"内核与内核模块"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#内核与内核模块","aria-hidden":"true"}},[a._v("#")]),a._v(" 内核与内核模块")]),a._v(" "),t("h3",{attrs:{id:"内核模块"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#内核模块","aria-hidden":"true"}},[a._v("#")]),a._v(" 内核模块")]),a._v(" "),t("p",[a._v("一般内核模块放置在"),t("code",[a._v("lib/modules/$(uname -r)/kernel")]),a._v("当中，包括arch, drivers和net等子文件。")]),a._v(" "),t("p",[a._v("在新建模块的时候，会遇到模块的依赖性问题，在 "),t("code",[a._v("lib/modules/$(uname -r/modules.dep)")]),a._v(" 文件中存储，这个文件的创建使用 "),t("code",[a._v("depmod [-Ane]")]),a._v(" 命令：")]),a._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[a._v("depmod "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("-Ane"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n-A: 查找到新模块再更新该文件\n-n: 不写入modules, 但在屏幕上输出\n-e: 显示出当前已加载但不可执行的模块名称\n")])])]),t("p",[a._v("举例：如果我做好了一个网卡驱动程序，文件名为a.ko，则更新内核模块：")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("cp")]),a._v(" a.ko /lib/modules/"),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("uname")]),a._v(" -r "),t("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("/kernel/drivers/net\ndepmod\n")])])]),t("h3",{attrs:{id:"内核模块的查看"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#内核模块的查看","aria-hidden":"true"}},[a._v("#")]),a._v(" 内核模块的查看")]),a._v(" "),t("p",[t("code",[a._v("lsmod")]),a._v("命令可查看已加载的模块，查看内核模块的信息，使用"),t("code",[a._v("modinfo")])]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("modinfo "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("-adln"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("module_name"),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v("filename"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n-a: 仅列出作者名称\n-d: 仅description\n-l: 仅列出授权\n-n: 列出该模块的详细路径\n")])])]),t("p",[a._v("e.g. 列出ath模块的路径："),t("code",[a._v("modinfo -n ath")])]),a._v(" "),t("h3",{attrs:{id:"内核模块的加载与删除"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#内核模块的加载与删除","aria-hidden":"true"}},[a._v("#")]),a._v(" 内核模块的加载与删除")]),a._v(" "),t("p",[t("code",[a._v("modprobe")]),a._v("命令可解决依赖性并决定需要加载的模块，优于"),t("code",[a._v("insmod")])]),a._v(" "),t("p",[a._v("对于删除模块：")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("rmmmod "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("-fw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" module_name\n-f: 强势删除，无论是否被使用\n-w: 若该模块在使用，则等待该模块使用完后再删除\n")])])]),t("p",[a._v("但是通常情况下，不推荐使用"),t("code",[a._v("insmod")]),a._v("和"),t("code",[a._v("rmmod")]),a._v("命令，万一模块存在依赖属性的问题时，将无法直接加载或删除该模块，所以使用"),t("code",[a._v("modprobe")]),a._v("来处理加载模块的问题：")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("modprobe "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("-lcfr"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" module_name\n-r: 删除某个模块\n")])])]),t("h3",{attrs:{id:"内核模块的额外参数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#内核模块的额外参数","aria-hidden":"true"}},[a._v("#")]),a._v(" 内核模块的额外参数")])])},[],!1,null,null,null);s.default=n.exports}}]);